<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile</title>
  <link rel="stylesheet" href="./style.css" />
  <style>
    .pageTitleFigma{ top:8px; left:8px; }

    .profileWrap{
      margin-top: 6px;
      height: calc(100% - 38px);
      display:flex;
      flex-direction:column;
    }

    .headerRow{
      display:grid;
      grid-template-columns: 28px 1fr 28px;
      align-items:center;
      gap:8px;
    }

    .ghostBtn{
      width:28px;height:28px;border:1.5px solid #222;border-radius:8px;background:#fff;cursor:pointer;
    }

    .headerTitle{
      text-align:center;
      font-weight:800;
      font-size:13px;
    }

    .bodyScroll{
      margin-top: 10px;
      flex:1;
      overflow:auto;
      padding-bottom: 12px;
    }

    .uploadCircle{
      width:156px;
      height:156px;
      border-radius:999px;
      background:#d9d9d9;
      margin:10px auto 0;
      display:grid;
      place-items:center;
      text-align:center;
      font-weight:800;
      cursor:pointer;
      overflow:hidden;
      border: none;
      color:#111;
      padding: 8px;
    }

    .uploadCircle img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .panelInput{
      width:100%;
      height:52px;
      border:1.5px solid #222;
      border-radius:10px;
      background:#fff;
      padding:0 14px;
      font-size:15px;
      display:flex;
      align-items:center;
      margin-top:10px;
    }

    .panelInput input{
      width:100%;
      border:none;
      outline:none;
      font-size:15px;
      background:transparent;
    }

    .contactBtn{
      width:100px;
      height:32px;
      border-radius:20px;
      border:1.5px solid #222;
      background:#fff;
      font-weight:700;
      cursor:pointer;
      margin-top: 22px;
    }

    .saveMsg{
      font-size:11px;
      color:#888;
      margin-top:8px;
      min-height:14px;
    }
  </style>
</head>
<body>
  <div class="centerWrap">
    <div class="phone">

      <div class="profileWrap">
        <div class="statusbar">
          <div>9:41</div>
          <div>ðŸ“¶ WiFi ðŸ”‹</div>
        </div>

        <div class="headerRow">
          <button id="btnBack" class="ghostBtn" type="button" title="Back"></button>
          <div class="headerTitle">New Group</div>
          <div id="topAvatar" class="topIconAvatar" title="Profile"></div>
        </div>

        <div class="hr"></div>

        <div class="bodyScroll">
          <div style="font-size:10px;font-weight:800;margin-bottom:6px;">Profile Picture</div>

          <button id="uploadBtn" class="uploadCircle" type="button">Upload Picture</button>
          <input id="fileInput" type="file" accept="image/*" capture="environment" style="display:none;">

          <div style="font-size:10px;font-weight:800;margin-top:14px;">Personal</div>

          <div class="panelInput">
            <input id="usernameInput" type="text" placeholder="User Name" />
          </div>

          <div id="userIdBox" class="panelInput" style="font-weight:800;">USER ID: xxxxxx</div>
          <div id="emailBox" class="panelInput" style="font-weight:700;color:#111;">User Email</div>

          <div class="saveMsg" id="saveMsg"></div>

          <button class="contactBtn" type="button">Contact Us</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./state.js"></script>
  <script>
    const btnBack = document.getElementById("btnBack");
    const topAvatar = document.getElementById("topAvatar");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const usernameInput = document.getElementById("usernameInput");
    const userIdBox = document.getElementById("userIdBox");
    const emailBox = document.getElementById("emailBox");
    const saveMsg = document.getElementById("saveMsg");

    function render() {
      const user = AppState.loadUser();

      AppState.applyTopRightAvatar(topAvatar);

      usernameInput.value = user.username || "";
      userIdBox.textContent = "USER ID: " + (user.userId || "xxxxxx");
      emailBox.textContent = user.email || "User Email";

      if (user.photoDataUrl) {
        uploadBtn.innerHTML = '<img src="' + user.photoDataUrl + '" alt="">';
      } else {
        uploadBtn.textContent = "Upload Picture";
      }
    }

    function compressImage(dataUrl) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const maxW = 900;
          let w = img.width;
          let h = img.height;
          if (w > maxW) {
            const ratio = maxW / w;
            w = Math.round(w * ratio);
            h = Math.round(h * ratio);
          }
          const c = document.createElement("canvas");
          c.width = w;
          c.height = h;
          const ctx = c.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          resolve(c.toDataURL("image/jpeg", 0.72));
        };
        img.onerror = reject;
        img.src = dataUrl;
      });
    }

    function saveNow(msg = "Saved") {
      AppState.updateCurrentUserInAllGroups();
      render();
      saveMsg.textContent = msg;
      setTimeout(() => {
        if (saveMsg.textContent === msg) saveMsg.textContent = "";
      }, 1200);
    }

    btnBack.onclick = () => {
      history.length > 1 ? history.back() : (location.href = "./dashboard.html");
    };

    uploadBtn.onclick = () => fileInput.click();

    fileInput.onchange = () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const compressed = await compressImage(String(reader.result || ""));
          AppState.saveUser({ photoDataUrl: compressed });
          saveNow("Photo saved");
        } catch (e) {
          console.error(e);
          saveMsg.textContent = "Image save failed";
        }
      };
      reader.readAsDataURL(file);
    };

    usernameInput.addEventListener("change", () => {
      AppState.saveUser({ username: usernameInput.value.trim() });
      saveNow("Name saved");
    });

    usernameInput.addEventListener("blur", () => {
      AppState.saveUser({ username: usernameInput.value.trim() });
      saveNow("Name saved");
    });

    render();
  </script>
</body>
</html>